# Playbook to configure all SQL Servers
# Written by: Hani Audah <ht.aramco@gmail.com>
# Created on: May/29/2020
# -------------------------------------------------------------------------------------------------
- import_playbook: allocate_host_variables.yml

- hosts: databases
  name: Configure SQL Servers
  vars_files:
    - "{{ playbook_dir }}/vault.yml"
    - "{{ playbook_dir }}/strings.yml"
    - "{{ playbook_dir }}/customizations.yml"
  vars:
    ansible_connection: winrm
    ansible_user: Administrator
    ansible_password: "{{ win_local_password }}"
    ansible_winrm_transport: ntlm
    ansible_port: 5985
  tasks:
    - name: Join server to domain
      win_domain_membership:
        dns_domain_name: "{{ domain_name }}"
        domain_admin_user: "{{ domain_admin_user }}@{{ domain_name }}"
        domain_admin_password: "{{ domain_admin_password }}"
        domain_ou_path: "{{ server_ou }}"
        state: domain
      register: join_domain

    - name: Reboot server when joining domain
      win_reboot:
      when: join_domain.reboot_required

    - name: Get SQL Server installation disc drive letter
      win_shell: Get-CimInstance Win32_LogicalDisk | ?{ $_.DriveType -eq 5 -and $_.VolumeName -eq 'SqlSetup_x64_ENU' } | % {$_.DeviceID}
      register: drive_output

    - name: Install SQL Server from mounted ISO
      win_package:
        path: D:\setup.exe
        product_id: '{0FB552DD-543E-48E7-A6F4-2F8D82723C6A}'
        arguments: >
          /IACCEPTSQLSERVERLICENSETERMS /ACTION="Install" /FEATURES=SQLEngine,Replication,Conn /INSTANCENAME="HARAMCODB"
          /SQLSYSADMINACCOUNTS="Haramco\Administrator" /SQLCOLLATION="Latin1_General_CI_AS" /qs
        state: present

    # The uninstall command is included for your reference only
    #- name: Uninstall SQL Server from mounted ISO
      #win_package:
        #path: D:\setup.exe
        #product_id: '{0FB552DD-543E-48E7-A6F4-2F8D82723C6A}'
        #arguments: >
          #/IACCEPTSQLSERVERLICENSETERMS /ACTION="Uninstall" /FEATURES=SQLEngine,Replication,Conn /INSTANCENAME="HARAMCODB" /qs
        #state: absent
