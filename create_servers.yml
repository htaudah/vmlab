# Playbook to deploy all inventory servers, leaving any configuration to the corresponding
# server-specific playbook. For now, all servers of a particular OS will have the same hardware
# specs. TODO: add server-specific specs to the inventory variables.
# Written by: Hani Audah <ht.aramco@gmail.com>
# Created on: May/25/2020
# -------------------------------------------------------------------------------------------------
- include_playbook: allocate_host_variables.yml

- hosts: localhost
  connection: local
  name: Create Infrastructure Servers
  vars_files:
    - "{{ playbook_dir }}/vault.yml"
    - "{{ playbook_dir }}/strings.yml"
    - "{{ playbook_dir }}/customizations.yml"
  tasks:
    - name: Create Windows virtual machines
      vars:
        computer_name: "{{ item }}"
      community.vmware.vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ workload_folder }}"
        name: "{{ userid }}-{{ item }}"
        state: poweredon
        guest_id: windows9Server64Guest
        template: "{{ template_win_2019 }}"
        hardware:
          memory_mb: 8192
          num_cpus: 2
          num_cpu_cores_per_socket: 1
          version: 14
        customization: "{{ custom_win_2019_workgroup }}"
        networks:
          - name: "{{ network_name }}"
            type: static
            ip: "{{ hostvars[item]['ansible_host'] }}"
            netmask: "{{ network_mask }}"
            gateway: "{{ network_gateway }}"
        resource_pool: "{{ resource_pool }}"
        wait_for_ip_address: yes
        wait_for_customization: yes
      register: create_windows_server
      loop: "{{ groups['windows'] }}"

    - name: Mount iso files where needed
      community.vmware.vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        name: "{{ userid }}-{{ item }}"
        state: present
        cdrom:
          - controller_type: sata
            controller_number: 0
            unit_number: 0
            type: iso
            iso_path: "{{ iso_paths[hostvars[item]['mount_iso']] }}"
      when: "{{ hostvars[item]['mount_iso'] is defined }}"
      loop: "{{ groups['windows'] }}"

    - name: Create Linux virtual machines
      vars:
        computer_name: "{{ item }}"
      community.vmware.vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ workload_folder }}"
        name: "{{ userid }}-{{ item }}"
        state: poweredon
        guest_id: centos8_64Guest
        template: "{{ template_centos_8 }}"
        customization: "{{ custom_centos_8 }}"
        networks:
          - name: "{{ network_name }}"
            type: static
            ip: "{{ hostvars[item]['ansible_host'] }}"
            netmask: "{{ network_mask }}"
            gateway: "{{ network_gateway }}"
        resource_pool: "{{ resource_pool }}"
        wait_for_ip_address: yes
        wait_for_customization: yes
      register: create_linux_server
      loop: "{{ groups['linux'] }}"
